
import { supabase } from "@/integrations/supabase/client";
import type { BirthData } from '@/pages/Index';

export interface AIReading {
  sunSign: string;
  moonSign: string;
  risingSign: string;
  analysis: string;
  cosmicMessage: string;
}

const generateFallbackReading = (birthData: BirthData): AIReading => {
  // Doƒüum tarihinden basit bur√ß hesaplama
  const birthDate = new Date(birthData.birthDate);
  const month = birthDate.getMonth() + 1;
  const day = birthDate.getDate();
  
  let sunSign = "Ko√ß";
  if ((month === 3 && day >= 21) || (month === 4 && day <= 19)) sunSign = "Ko√ß";
  else if ((month === 4 && day >= 20) || (month === 5 && day <= 20)) sunSign = "Boƒüa";
  else if ((month === 5 && day >= 21) || (month === 6 && day <= 20)) sunSign = "ƒ∞kizler";
  else if ((month === 6 && day >= 21) || (month === 7 && day <= 22)) sunSign = "Yenge√ß";
  else if ((month === 7 && day >= 23) || (month === 8 && day <= 22)) sunSign = "Aslan";
  else if ((month === 8 && day >= 23) || (month === 9 && day <= 22)) sunSign = "Ba≈üak";
  else if ((month === 9 && day >= 23) || (month === 10 && day <= 22)) sunSign = "Terazi";
  else if ((month === 10 && day >= 23) || (month === 11 && day <= 21)) sunSign = "Akrep";
  else if ((month === 11 && day >= 22) || (month === 12 && day <= 21)) sunSign = "Yay";
  else if ((month === 12 && day >= 22) || (month === 1 && day <= 19)) sunSign = "Oƒülak";
  else if ((month === 1 && day >= 20) || (month === 2 && day <= 18)) sunSign = "Kova";
  else sunSign = "Balƒ±k";

  // √áok daha detaylƒ± ve profesyonel analiz
  const detailedAnalyses = {
    "Ko√ß": `${birthData.fullName}, sen doƒüu≈ütan bir lider ve √∂nc√ºs√ºn! ${birthData.birthCity}'deki doƒüumun sana g√º√ßl√º bir enerji vermi≈ü. Bu hafta Mars enerjisi seninle - cesaret ve kararlƒ±lƒ±k zamanƒ±. √ñzellikle ${new Date().toLocaleDateString('tr-TR', { weekday: 'long' })} g√ºn√º senin i√ßin d√∂n√ºm noktasƒ± olabilir.

üî• Enerji Analizi: Ate≈ü elementinin g√ºc√º bu d√∂nemde seninle. ƒ∞√ßindeki yaratƒ±cƒ± ate≈ü yanƒ±yor ve yeni projelere ba≈ülamak i√ßin m√ºkemmel bir zaman.

üí´ Ki≈üisel Geli≈üim: Sabƒ±rsƒ±zlƒ±ƒüƒ±n bazen seni zorlasa da, bu hafta bunu avantaja √ßevirebilirsin. Liderlik √∂zelliklerinin √∂n plana √ßƒ±kacaƒüƒ± durumlarla kar≈üƒ±la≈üacaksƒ±n.

üåü ƒ∞li≈ükiler: Sosyal √ßevren senin enerjinden etkilenecek. √áevrendeki insanlarƒ± motive etme g√ºc√ºn bu d√∂nemde artƒ±yor.`,

    "Boƒüa": `${birthData.fullName}, senin sakinliƒüin ve kararlƒ±lƒ±ƒüƒ±n bu d√∂nemde b√ºy√ºk g√º√ß! ${birthData.birthCity}'nin toprak enerjisi seninle uyum halinde. Ven√ºs'√ºn etkisi altƒ±nda g√ºzellik ve harmoniye odaklanacaƒüƒ±n bir d√∂nemdesin.

üå± Toprak Elementi: Pratik zek√¢n ve sabƒ±rƒ±n bu hafta sana b√ºy√ºk avantajlar saƒülayacak. Uzun vadeli planlarƒ±n i√ßin m√ºkemmel bir zaman.

üíö Bolluk Enerjisi: Maddi konularda pozitif geli≈ümeler seni bekliyor. Sabƒ±rla beklediƒüin fƒ±rsatlar kapƒ±nƒ± √ßalmaya ba≈ülayacak.

üé® Yaratƒ±cƒ±lƒ±k: Sanatsal yeteneklerin ve estetik anlayƒ±≈üƒ±n bu d√∂nemde parlayacak. El becerin ve yaratƒ±cƒ±lƒ±ƒüƒ±n dikkat √ßekecek.`,

    "ƒ∞kizler": `${birthData.fullName}, zihnin bu hafta tam bir fƒ±rtƒ±na! ${birthData.birthCity}'deki doƒüumun sana hƒ±zlƒ± d√º≈ü√ºnme yetisi kazandƒ±rmƒ±≈ü. Merk√ºr'√ºn etkisiyle ileti≈üim becerilerin zirveye √ßƒ±kacak.

üå™Ô∏è Hava Elementi: D√º≈ü√ºncelerinin hƒ±zƒ± ve √ßok y√∂nl√ºl√ºƒü√ºn bu d√∂nemde seni √∂ne √ßƒ±karacak. Birden fazla projeyi aynƒ± anda y√ºr√ºtebilirsin.

üì° ƒ∞leti≈üim G√ºc√º: Sosyal medya ve ileti≈üim kanallarƒ±nda etkili olacaƒüƒ±n bir d√∂nem. Fikirlerini payla≈ümaktan √ßekinme.

üé≠ Adaptasyon: Deƒüi≈üen ≈üartlara hƒ±zla uyum saƒülama yeteneƒüin bu hafta sana b√ºy√ºk avantaj saƒülayacak.`,

    "Yenge√ß": `${birthData.fullName}, duygusal derinliƒüin bu d√∂nemde b√ºy√ºk bir hazine! ${birthData.birthCity}'deki doƒüumun sana g√º√ßl√º sezgiler vermi≈ü. Ay'ƒ±n etkisiyle i√ßsel bilgeliƒüin artƒ±yor.

üåä Su Elementi: Empatin ve sezgilerin bu hafta seni doƒüru y√∂nlendiriecek. ƒ∞√ßsel sesin daima haklƒ± √ßƒ±kacak.

üè† Aile Baƒülarƒ±: Yakƒ±n √ßevren ve ailen bu d√∂nemde sana destek olacak. Ev ve aile konularƒ±nda olumlu geli≈ümeler ya≈üayacaksƒ±n.

üíñ Duygusal Zeka: Ba≈ükalarƒ±nƒ±n duygularƒ±nƒ± anlama yeteneƒüin bu hafta seni √ßok deƒüerli kƒ±lacak. ƒ∞nsanlar sana g√ºvenmeye devam edecek.`,

    "Aslan": `${birthData.fullName}, kraliyet havasƒ±n bu hafta t√ºm g√∂rkemiyle ortaya √ßƒ±kacak! ${birthData.birthCity}'deki doƒüumun sana doƒüal bir liderlik vermi≈ü. G√ºne≈ü'in enerjisi seninle tam uyumda.

‚òÄÔ∏è G√ºne≈ü Enerjisi: I≈üƒ±ltƒ±n ve karizma bu d√∂nemde herkesi etkileyecek. Sahne senin, g√∂zler √ºzerinde olacak.

üëë Liderlik: Doƒüal liderlik √∂zelliklerinin bu hafta fark edilecek. √ñnemli sorumluluklar sana verilmek istenebilir.

üé™ Yaratƒ±cƒ±lƒ±k: Sanatsal yeteneklerin ve performans g√ºc√ºn bu d√∂nemde parlayacak. Kendini ifade etme konusunda cesur ol.`,

    "Ba≈üak": `${birthData.fullName}, m√ºkemmeliyet√ßiliƒüin bu hafta sana b√ºy√ºk ba≈üarƒ±lar getirecek! ${birthData.birthCity}'deki doƒüumun sana titizlik ve analitik d√º≈ü√ºnce vermi≈ü.

üîç Detaycƒ±lƒ±k: Herkesin g√∂zden ka√ßƒ±rdƒ±ƒüƒ± ayrƒ±ntƒ±larƒ± sen fark edeceksin. Bu hafta hatalarƒ±nƒ± d√ºzeltme zamanƒ±.

üìä Organizasyon: Planlama ve organize etme becerin bu d√∂nemde √ßok deƒüerli olacak. Etrafƒ±ndakiler senden tavsiye isteyecek.

üå± Geli≈üim: Kendini geli≈ütirme konusundaki √ßaban bu hafta meyvelerini vermeye ba≈ülayacak.`,

    "Terazi": `${birthData.fullName}, dengeni bulu≈üun ve zarafetinle bu hafta herkesi b√ºy√ºleyeceksin! ${birthData.birthCity}'deki doƒüumun sana doƒüal bir diplomasi yeteneƒüi vermi≈ü.

‚öñÔ∏è Denge Sanatƒ±: Zƒ±t kutuplarƒ± bir araya getirme yeteneƒüin bu hafta √ßok i≈üine yarayacak. √áatƒ±≈ümalarƒ± √ß√∂zme konusunda ba≈üvurulacak ki≈üi sen olacaksƒ±n.

üí´ Sosyal √áekim: G√ºzellik anlayƒ±≈üƒ±n ve sosyal becerin bu d√∂nemde dikkat √ßekecek. Yeni dostluklar ve baƒülantƒ±lar kurabilirsin.

üé® Estetik Anlayƒ±≈ü: Sanat ve g√ºzellik konularƒ±nda verceƒüin kararlar takdir g√∂recek.`,

    "Akrep": `${birthData.fullName}, derin sezgilerin ve g√º√ßl√º iraden bu hafta sƒ±rrƒ±nƒ± a√ßacak! ${birthData.birthCity}'deki doƒüumun sana mistik bir g√º√ß vermi≈ü.

ü¶Ç D√∂n√º≈ü√ºm G√ºc√º: Bu hafta b√ºy√ºk bir deƒüi≈üim ve d√∂n√º≈ü√ºm ge√ßirebilirsin. Eski halinden √ßok daha g√º√ßl√º √ßƒ±kacaksƒ±n.

üîÆ Sezgisel G√º√ß: ƒ∞√ßsel sesini dinlediƒüinde doƒüru kararlarƒ± verme konusunda ≈üa≈üƒ±rtƒ±cƒ± ba≈üarƒ±lar elde edeceksin.

üíé Gizli Yetenekler: ≈ûimdiye kadar ke≈üfetmediƒüin yeteneklerin bu d√∂nemde ortaya √ßƒ±kmaya ba≈ülayabilir.`,

    "Yay": `${birthData.fullName}, macera ruhu ve √∂zg√ºrl√ºk a≈ükƒ±nla bu hafta yeni ufuklara yelken a√ßacaksƒ±n! ${birthData.birthCity}'deki doƒüumun sana ke≈üfetme arzusu vermi≈ü.

üèπ Hedef Odaklƒ±lƒ±k: Belirlediƒüin hedeflere ula≈üma konusunda bu hafta b√ºy√ºk ilerlemeler kaydedeceksin.

üåç Geni≈ülik: Ufkunu geni≈ületecek fƒ±rsatlarla kar≈üƒ±la≈üacaksƒ±n. Yeni yerler, yeni insanlar, yeni fikirler...

üìö √ñƒürenme: Bilgi arayƒ±≈üƒ±n bu d√∂nemde seni √ßok ilgin√ß ke≈üiflere g√∂t√ºrecek.`,

    "Oƒülak": `${birthData.fullName}, kararlƒ±lƒ±ƒüƒ±n ve sebatƒ±nla bu hafta daƒülarƒ± bile a≈üabilirsin! ${birthData.birthCity}'deki doƒüumun sana √ßelik gibi bir irade vermi≈ü.

‚õ∞Ô∏è Zirve Yolculuƒüu: Uzun s√ºredir √ºzerinde √ßalƒ±≈ütƒ±ƒüƒ±n projeler bu hafta sonu√ß vermeye ba≈ülayacak.

üëî Otorite: Profesyonel alanda saygƒ±nlƒ±ƒüƒ±n artacak. S√∂z sahibi olmaya ba≈ülayacaƒüƒ±n konular olabilir.

üèóÔ∏è Yapƒ±cƒ±lƒ±k: Somut ve kalƒ±cƒ± i≈üler yaratma konusundaki yeteneƒüin bu d√∂nemde fark edilecek.`,

    "Kova": `${birthData.fullName}, √∂zg√ºn d√º≈ü√ºncelerin ve yenilik√ßi yakla≈üƒ±mƒ±nla bu hafta √ßevrendeki herkesi ≈üa≈üƒ±rtacaksƒ±n! ${birthData.birthCity}'deki doƒüumun sana farklƒ± bakƒ±≈ü a√ßƒ±sƒ± vermi≈ü.

‚ö° Yenilik Enerjisi: Teknoloji ve yeniliklere olan ilgin bu hafta sana avantajlar saƒülayacak.

üåê Toplumsal Farkƒ±ndalƒ±k: ƒ∞nsanlƒ±ƒüa faydalƒ± olacak fikirler geli≈ütirme konusunda ilham alacaksƒ±n.

üî¨ Bilimsel Merak: Ara≈ütƒ±rma ve ke≈üfetme konusundaki merakƒ±n seni yeni bilgilere g√∂t√ºrecek.`,

    "Balƒ±k": `${birthData.fullName}, sonsuz hayal g√ºc√ºn ve duygusal derinliƒüinle bu hafta adeta b√ºy√º yaratacaksƒ±n! ${birthData.birthCity}'deki doƒüumun sana mistik bir baƒülantƒ± vermi≈ü.

üê† Akƒ±≈ü Halinde: Hayatƒ±n akƒ±≈üƒ±na uyum saƒülama yeteneƒüin bu hafta seni doƒüru yerlere g√∂t√ºrecek.

üé® Sanatsal Ruh: Yaratƒ±cƒ± projelerinp bu d√∂nemde b√ºy√ºk ilgi g√∂recek. ƒ∞lham perilerin seninle.

üí´ Ruhsal Baƒülantƒ±: Manevi konulara olan ilgin artacak ve bu alanda derin tecr√ºbeler ya≈üayabilirsin.`
  };

  const analysis = detailedAnalyses[sunSign as keyof typeof detailedAnalyses] || detailedAnalyses["Ko√ß"];

  return {
    sunSign: sunSign,
    moonSign: "Aslan", // √ñrnek
    risingSign: "Terazi", // √ñrnek
    analysis,
    cosmicMessage: "Evren sana bu hafta √∂zel bir mesaj g√∂nderiyor: ƒ∞√ßindeki g√ºc√º ke≈üfetme zamanƒ± geldi! ‚ú®"
  };
};

export const generateAIAstrologyReading = async (birthData: BirthData): Promise<AIReading> => {
  console.log('Calling AI astrology reading function...');
  
  try {
    const { data, error } = await supabase.functions.invoke('generate-astrology-reading', {
      body: { birthData }
    });

    if (error) {
      console.error('Supabase function error:', error);
      console.log('Falling back to enhanced demo reading due to API error');
      return generateFallbackReading(birthData);
    }

    if (!data.success) {
      console.log('API call unsuccessful, using enhanced fallback reading');
      return generateFallbackReading(birthData);
    }

    console.log('AI reading received:', data.reading);

    // Parse the AI response to extract different sections
    const reading = data.reading;
    
    // Extract sun sign
    const sunSignMatch = reading.match(/\*\*G√ºne≈ü Burcu\*\*:\s*(.+?)(?:\n|\*\*)/);
    const sunSign = sunSignMatch ? sunSignMatch[1].trim() : 'Bilinmiyor';
    
    // Extract moon sign
    const moonSignMatch = reading.match(/\*\*Ay Burcu\*\*:\s*(.+?)(?:\n|\*\*)/);
    const moonSign = moonSignMatch ? moonSignMatch[1].trim() : 'Bilinmiyor';
    
    // Extract rising sign
    const risingSignMatch = reading.match(/\*\*Y√ºkselen Burcu\*\*:\s*(.+?)(?:\n|\*\*)/);
    const risingSign = risingSignMatch ? risingSignMatch[1].trim() : 'Bilinmiyor';
    
    // Extract analysis (everything between daily analysis and cosmic message)
    const analysisMatch = reading.match(/\*\*Bug√ºn√ºn Astrolojik Analizi\*\*:\s*([\s\S]*?)\*\*Evrenin Sana Mesajƒ±\*\*/);
    const analysis = analysisMatch ? analysisMatch[1].trim() : reading;
    
    // Extract cosmic message
    const cosmicMatch = reading.match(/\*\*Evrenin Sana Mesajƒ±\*\*:\s*([\s\S]*?)$/);
    const cosmicMessage = cosmicMatch ? cosmicMatch[1].trim() : 'Yƒ±ldƒ±zlar sana her zaman rehberlik eder.';

    return {
      sunSign,
      moonSign,
      risingSign,
      analysis,
      cosmicMessage
    };

  } catch (error) {
    console.error('Error generating AI reading:', error);
    console.log('Using enhanced fallback reading due to exception');
    return generateFallbackReading(birthData);
  }
};
